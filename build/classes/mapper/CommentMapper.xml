<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.seok.mapper.CommentMapper">

	<!-- 댓글/대댓글 등록 -->
	<insert id="insertComment" parameterType="com.seok.dto.Comment">
		INSERT INTO comments (
		board_id, writer_num, parent_id, content)
		VALUES
		(
		#{boardId}, #{writerNum},
		<choose>
			<when test="parent_id != null">#{parentId}</when>
			<otherwise>NULL</otherwise>
		</choose>
		, #{content}
		);
	</insert>

	<!-- 댓글/대댓글 수정 -->
	<update id="updateComment" parameterType="com.seok.dto.Comment">
		UPDATE comments
		SET
		content = #{content}
		WHERE comment_id = #{commentId}
		AND deleted_at IS
		NULL;
	</update>

	<!-- 댓글/대댓글 삭제 -->
	<update id="deleteComment" parameterType="int">
		UPDATE comments
		SET
		deleted_at = NOW()
		WHERE comment_id = #{commentId};
		AND deleted_at IS
		NULL;
	</update>

	<!-- 댓글/대댓글 목록 조회 -->
	<select id="selectComments" parameterType="int"
		resultType="com.seok.dto.Comment">
		SELECT *
		  FROM comments
		 WHERE board_id = #{boardId}
		   AND deleted_at IS NULL
		 ORDER BY CASE WHEN parent_id IS NULL THEN comment_id
		  		  	   ELSE parent_id
				   	    END,
   				  created_at ASC;
	</select>

	<!-- 댓글 수 반영 -->
	<update id="updateBoardCommentCount" parameterType="int">
		UPDATE boards
		   SET comment_count = (SELECT COUNT(*)
				  		          FROM comments
							     WHERE board_id = #{boardId}
							   	   AND deleted_at IS NULL)
		 WHERE board_id      = #{boardId};
	</update>
	
</mapper>